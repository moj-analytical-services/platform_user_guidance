# Amazon S3

## What is Amazon S3?

[Amazon S3](https://aws.amazon.com/s3/) is a web-based cloud storage platform. It is one of the primary file storage locations on the Analytical Platform, alongside individual users' home directories.

Amazon S3 should be used to store large files and any files that need to be accessed by muliple users.

Data stored in Amazon S3 can be seamlessly integrated with other AWS services such as Amazon Athena and Amazon Glue.

## Working with Amazon S3 buckets

### Types of buckets

*   Warehouse data sources
*   App data sources

What is the distinction and what can users do?

### Create a new bucket

Standard users can currently only create new warehouse data sources in the Analytical Platform control panel. __You cannot create new buckets directly in the Amazon S3 console.__

To create a new warehouse data source:

1.  Go to the Analytical Platform [control panel](https://cpanel-master.services.alpha.mojanalytics.xyz).
2.  Select the 'Warehouse data' tab.
3.  Select 'Create a new warehouse data source'.
4.  Enter a name for the warehouse data source -- this must be prefixed with '-alpha'.
5.  Select 'Create'.

When you create a new warehouse data source, only you will initially have access. As an admin of the data source, you will be able to add and remove other users from the data access group as required. Further information on managing data access groups can be found in Section \@ref(manage-access-to-a-bucket).

### Access levels

Every bucket has three access levels:

*   Read only
*   Read/write
*   Admin

### Request access to a bucket

To gain access to a bucket (warehouse data source or app data source), you must be added to the relevant data access group.

If you know an admin of the bucket you require access to, you can ask them to add you to the data access group.

If you do not know any of the admins of the bucket you require access to, you can ask the Analytical Platform team to add you to the data access group on the [#ap_admin_request](https://asdslack.slack.com/messages/CBLAGCQG6/) Slack channel or by [email](mailto:analytical_platform@digital.justice.gov.uk).

When requesting access to a bucket, you should specify the name of the bucket and the level of access you require.

### Manage access to a bucket{#manage-access-to-a-bucket}

Bucket admins can currently only manage access to warehouse data sources in the Analytical Platform [control panel](https://cpanel-master.services.alpha.mojanalytics.xyz/). __You cannot manage access to buckets directly in the Amazon S3 console.__

To manage access to a warehouse data source:

1.  Go to the Analytical Platform [control panel](https://cpanel-master.services.alpha.mojanalytics.xyz).
2.  Select the 'Warehouse data' tab.
3.  Select the name of the warehouse data source you wish to manage.

To add a new user to the data access group:

1.  Type their GitHub username into the input field labelled 'Grant access to this data to other users'.
2.  Select the user from the drop-down list.
3.  Select 'Grant access'.

To edit the access level of a user:

1.  Select 'Edit access level' next to the name of the user.
2.  Select the checkbox next to the access level you wish to grant the user.
3.  Select 'Save'.

To remove a user from the data access group:

1.  Select 'Edit access level' next to the name of the user.
2.  Select 'Revoke access'.

## Upload data to Amazon S3

*   You should follow information governance procedures when uploading data to Amazon S3.

### Amazon S3 Console

### RStudio

### JupyterLab

## Download data from Amazon S3

### Amazon S3 Console

### RStudio

#### `s3tools`

#### `s3browser`

### JupyterLab

[Amazon S3](https://en.wikipedia.org/wiki/Amazon_S3) is used as the primary storage area for large data files. In contrast to data in your Platform's home directory, data in S3 can be accessed by multiple Platform users. You will only be able to access S3 buckets (folders) that you have been granted access to.

## Accessing data in S3 from R

There are currently two methods of browsing and importing data held in S3 into RStudio.

### User Interface

We have developed a user interface that allows you to search and browse the files that you have been given access to.

![](images/s3/s3browser.png)

You can access this interface by typing the following command into your R Studio console:
```r
s3browser::file_explorer_s3()
```

See the [documentation](https://github.com/moj-analytical-services/s3browser) for further details.

### R Package

We have also developed an R Package called `s3tools` that makes it easier to interact with s3. This enables you to do things like write `s3tools::s3_path_to_full_df("alpha-everyone/iris.csv")` to read directly from S3 into a data frame in R.

See the [documentation](https://github.com/moj-analytical-services/s3tools) for
further details.

## Importing data from S3 into JupyterLab

Pandas can import straight from S3:

    import pandas as pd
    pd.read_csv("s3://alpha-everyone/iris.csv")

This requires you to install this library:

    pip install s3fs

Or alternatively use the standard python AWS client `boto3`.

If using Spark (and the Jupyter deployment including the Spark libraries):

    spark.read.csv("s3a://blah")

These 'direct reads' should be faster than downloading from S3 to your machine and using JupyterLab to uploading to your home drive.

## Writing data from JupyterLab to S3

pandas won't write files to S3 directly. Instead either:
* write data to a temporary file on disk and copy the file to S3 with boto3
* write data to a memory buffer and copy the file to S3 with boto3 like this:

```python
from io import StringIO
import boto3

csv_buffer = StringIO()
df.to_csv(csv_buffer)
s3_resource = boto3.resource('s3')
s3_resource.Object(bucket, 'df.csv').put(Body=csv_buffer.getvalue())
```

## Uploading data to S3 (from your machine)

### Where data is stored

Data in S3 is stored in 'buckets', which are conceptually very similar to folders.

Each of these 'buckets' has a corresponding 'data access group' which is the group of platform users who have access to the bucket.

Each data access group has one or more administrators, who are able to add and remove people from the group.

Typically, a suitable bucket will already exist for the work you are doing, so you just need to ask the data access group administrator to add you.

If it does not already exist, you may create a new 'bucket'.  In doing so, you will automatically become the administrator of this data access group.

### Uploading data

The easiest way to upload data to an S3 buckets is via the AWS GUI.  Instructions are as follows:

- Navigate to the platform [control panel](https://cpanel-master.services.alpha.mojanalytics.xyz/#Warehouse%20data), and click on the 'warehouse data' tab.
- Look for the bucket you want to upload data to, and click the 'Open on AWS' button, which will take you into the AWS GUI
- Within AWS, click the blue 'Upload' button
- Drag files in as instructed
- Click the 'Upload' button at the bottom *left* of the dialogue.

You can also move, rename and delete data using the AWS GUI. Select the files by checking the text box, use the `More` button so see the options.

![](images/s3/s3_options.png)

## Creating and managing data access groups

Before creating a new S3 bucket and corresponding data access group, please check that a suitable S3 bucket does not already exist.

You can do this by navigating 'up a level' within the AWS S3 GUI, by clicking on 'Amazon S3' at the top left of the screen.  [TODO: Add picture]

This will show you a list of all S3 buckets within the platform, including buckets you do not have access to.

Assuming a suitable bucket does not already exist, you can create a new one as follows:

### Step 1 - Create a new bucket

Navigate to the ['Data Warehouse' tab of the control panel](https://cpanel-master.services.alpha.mojanalytics.xyz/#Warehouse%20data).  At the bottom of the page, click on 'Create new warehouse data source'.

Type a name for your S3 bucket.  Note that for technical reasons, all buckets must start with `alpha-`, which will be populated for you automatically

### Step 2 (optional) Grant access to other users, and set their access level

Navigate to the ['Data Warehouse' tab of the control panel](https://cpanel-master.services.alpha.mojanalytics.xyz/#Warehouse%20data). Click on the name of the bucket you wish to manage.

Scroll to the bottom of the page, and start typing a user's name in the 'Grant access to this data to other users' box.

If you want to grant administrator priviledges on another user click on the 'Edit access level' button next to their name.  This will enable them to manage the data access group.  Each group can have multiple administrators.

